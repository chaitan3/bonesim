{{extend 'content.html'}}

<style>
	#canvas			{
				border:			1pt solid #000;
				margin:			0px;
				padding:		0px;
				position:		relative;
				left:			5px;
				width:			99%;
				height:			88%;
				overflow-x:		scroll;
				overflow-y:		scroll;
				}
	#canvas div		{
				border:			none;
				position:		absolute;
				margin:			0px;
				padding:		0px;
				padding-top:		7px;
				color:			white;
				background-color:	green;
				opacity:		.15;
				text-align:		center;
				}
	#canvas div:hover	{
				cursor:			pointer;
				opacity:		1;
				}
	#canvas img		{
				position:		relative;
				top:			0px;
				left:			0px;
/*				width:			95%;*/
				margin:			0px;
				padding:		0px;
				}
</style>

<script>
	function zoom(add) {
		width = document.network.offsetWidth;
		if ( width + add > 100 ) document.network.style.width = width + add;
		}

	function handle(delta) {
		if (delta < 0)
			zoom(-60);
		else
			zoom(60);
	}

	/* Code below adapted from http://www.adomas.org/javascript-mouse-wheel/ */
	/* Thanks to Adomas Paltanavicius */

	function wheel(event){
		var delta = 0;
		if (!event) event = window.event;
		if (event.wheelDelta) {
			delta = event.wheelDelta/120; 
		} else if (event.detail) {
			delta = -event.detail/3;
		}
		if (delta)
			handle(delta);
		if (event.preventDefault)
		        event.preventDefault();
		event.returnValue = false;
	}

	if (window.addEventListener)
		window.addEventListener('DOMMouseScroll', wheel, false);
	window.onmousewheel = document.onmousewheel = wheel;

	function ChangeVisibility(event) {
		if ( event.srcElement.checked ) value = 'visible'
		else value = 'hidden';
		for (var i = 0; i < Boxes.length; i++) document.getElementById(Boxes[i]).style.visibility = value;
		}

	function Reset() {
		document.getElementById('Progress').innerHTML = 'Resetting ...';
		request = new XMLHttpRequest();
		request.open('GET', '{{ = URL(r=request, c="BooleanNet", f="reset") }}', true);
		request.onreadystatechange = function()	{
						 	if (request.readyState==4 && request.status==200) for (var i = 0; i < Boxes.length; i++) document.getElementById(Boxes[i]).style.background = 'green';
							}
		request.send(null);
		}

	function PerformUpdate(StateSpace) {
		s = StateSpace.split('\n');
		for (var i = 0; i < s.length/2; i++) {
			e = document.getElementById( s[i*2] );
			if ( e == null ) alert('Node not found: '+s[i*2])
			else	{
				value = s[i*2+1];
				if ( value == 'True' )	e.style.background = 'green'
				else			e.style.background = 'red';
				}
			}
		document.getElementById('Progress').innerHTML = 'Updated.';
		}

	function Update() {
		document.getElementById('Progress').innerHTML = 'Updating ...';
		r = new XMLHttpRequest();
		r.open('GET', '{{=URL(r=request, c="BooleanNet", f="status")}}', true);
		r.onreadystatechange = function()	{
						 	if (r.readyState==4 && r.status==200) PerformUpdate(r.responseText);
							}
		r.send(null);
		}

	function Iterate() {
		document.getElementById('Progress').innerHTML = 'Iterating ...';
		request = new XMLHttpRequest();
		request.open('GET', '{{=URL(r=request, c="BooleanNet", f="iterate")}}', true);
		request.onreadystatechange = function()	{
						 	if (request.readyState==4 && request.status==200) Update();
							}
		request.send(null);
		}	

	function setState(label, state) {
		request = new XMLHttpRequest();
		request.open('GET', '{{=URL(r=request, c="BooleanNet", f="setState")}}?id='+label+'&state='+state, true);
		request.onreadystatechange = function()	{
						 	if (request.readyState==4 && request.status==200) Iterate();
							}
		request.send(null);
		}

	function ChangeState(event) {
		document.getElementById('Progress').innerHTML = 'Changing node ...';
		e = event.srcElement;
		currently = e.style.background;
		if ( currently == 'red' ) state = false
		else state = true;

		if ( state == true ) {
			setState(e.id, false);
			e.style.background = 'red';
		} else {
			setState(e.id, true);
			e.style.background = 'green';
			}
		}
</script>

[ <a href="../Layout/graphviz">Redo layout</a> ], 
[ <a href="../Layout/graphviz_layout">Download DOT layout</a> ], 
[ <a href="../Export/JSON">Download JSON model</a> ], 
[ <a href="{{ = session.graphviz_png }}">Download picture</a> ]

<form name=main action="{{=URL(r=request, c='Import', f='BooleanNet')}}" method=POST enctype="multipart/form-data" style="margin:0px; float:right;">
	<input type=button value="Reset" onClick="Reset();" />
	<input type=button value="Iterate" onClick="Iterate();" />
	<input type=hidden name=Layouter value=graphviz />
{{ if os.path.exists('/home/Master/Network/Whi2p.boolenet'): }}
	<input type=submit value="Load Matthias's Whi2p Network" />
{{ pass }}
</form>

<input id=ShowBooleBoxes type=checkbox onClick="ChangeVisibility(event);" checked> Show boolean network boxes

<br/>
Use mouse wheel to zoom in or out. <label id='Progress' style='color:green; font-weight:bold;'></label>

<div id=canvas>

	<img name=network src="{{ = session.graphviz_image }}" />

{{ = XML(BoundingBoxes) }}

	<script>Boxes = new Array({{ = XML(Boxes) }});</script>

</div>
