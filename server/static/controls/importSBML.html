<html>

<style>
	body		{
			background-color:	black;
			}
	table		{
			border:			none;
			margin:			0;
			padding:		0;
			width:			100%;
			height:			100%;
			}
	#Tron		{
			display:		none;
			}
	#ProgressCol	{
			display:		none;
			text-align:		right;
			}
	#debug		{
			color:			green;
			font-weight:		bold;
			}
</style>

<script src="{{tools}}/tools.js"></script>

<script>
	function Load() {
		document.getElementById('LoadCol').style.display = 'none';
		document.getElementById('ProgressCol').style.display = 'inline';
		rotateAroundCenter();
		debug('Opening file ...');
		var reader = new FileReader();
		reader.readAsText(document.getElementById('File').files[0]);
		reader.onload = Opened;
		}

	function Opened(evt) {
		debug('Opened.');
		SBML = evt.target.result;
		debug('Asking the server for a translation ...');
		window.setTimeout('Translate();', 100);
		}

	function Translate() {
		translated = POST('{{biographer}}/Translate/SBML', 'SBML='+SBML).replace('\n','').replace('\t','');
		window.open('data:text/html,translated');
		debug('Translated. Parsing JSON ...');
		window.setTimeout('Parse();', 100);
		}

	function Parse() {
		try 	{	// json = JSON.parse(translated);
				eval('json = '+translated+';');	// very dangerous for man-in-the middle code injection !!!
								// but seems to be faster
			}
		catch(err) {	debug('Fatal: JSON parsing failed.');
				alert('Server did not send a valid JSON response!');
				return
			}
		debug('Translation successfully parsed. '+json['nodes'].length+' nodes, '+json['edges'].length+' edges. <br>Trying to update UI ...');
		window.opener.network = json;
		window.setTimeout('UpdateUI();', 100);
		}

	function UpdateUI() {
		bui = window.opener.bui;
		graph = window.opener.graph;
		bui.importFromJSON(graph, json);
		debug('Done.');
		window.setTimeout('window.close();', 1000);
		}

</script>

<body>
	<table>
		<tr>
			<td>
				<img src="{{images}}/SBML.png" style="vertical-align:middle;"/>
			</td>
			<td id=ProgressCol>
				<img id=Tron src="{{images}}/Progress.svg"/>
				<canvas id=canvas width=70 height=70></canvas>
				<script>
					canvas = document.getElementById('canvas');
					img = document.getElementById('Tron');
					function rotateAroundCenter() {
						alpha = 15;
						width = 70;
						height = 70;
						var context = canvas.getContext('2d');
						context.translate(width/2, height/2);
						context.rotate(alpha*Math.PI/180);
						context.translate(-width/2, -height/2);
						context.drawImage(img, 0, 0);
						window.setTimeout('rotateAroundCenter();', 50);
						}
				</script>
			</td>
			<td id=LoadCol>
				<input type=file id=File onchange="Load();" />
				<br/>
				<input type=button value=Cancel onclick="window.close();" />
			</td>
		</tr>
		<tr>
			<td colspan=3>
				<label id=debug></label>
				<script>
					function debug(text) {
						document.getElementById('debug').innerHTML = text;
						}
				</script>
			</td>
		</tr>
	</table>
</body>

</html>
