{{extend 'content.html'}}

<style>
	#Controls		{
				border:			1px solid black;
				position:		absolute;
				top:			-5%;
				right:			1%;
				}

	#canvas			{
				border:			1px solid black;
				margin:			0px;
				padding:		0px;
				position:		relative;
				left:			5px;
				width:			99%;
				height:			94%;
				overflow-x:		scroll;
				overflow-y:		scroll;
				}
	#canvas div		{
				border:			none;
				position:		absolute;
				margin:			0px;
				padding:		0px;
				padding-top:		7px;
				color:			white;
				background-color:	green;
				opacity:		.4;
				text-align:		center;
				}
	#canvas div:hover	{
				cursor:			pointer;
				opacity:		.7;
				}
	#canvas img		{
				position:		relative;
				top:			0px;
				left:			0px;
/*				width:			95%;*/
				margin:			0px;
				padding:		0px;
				}
</style>

<script>
	function zoom(add) {
		width = document.network.offsetWidth;
		if ( width + add > 100 ) document.network.style.width = width + add;
		}

	function zoom_divs(add) {
		for (var i = 0; i < Boxes.length; i++) {
			box = document.getElementById(Boxes[i]);
			box.style.width = box.offsetWidth*(1+add);
//			box.style.height = box.offsetHeight*(1+add);	// FIXME: Chrome bug?
			box.style.left = box.offsetLeft*(1+add);
			box.style.top = box.offsetTop*(1+add);
			}
		}

	function adjust_size() {
		network = document.getElementById('network');
		picw = network.offsetWidth;
//		pich = network.offsetHeight;
		maxx = 0;
//		maxy = 0;
		for (var i = 0; i < Boxes.length; i++) {
			box = document.getElementById(Boxes[i]);
			max_x = box.offsetLeft + box.offsetWidth;
			if ( max_x > maxx ) maxx = max_x;
//			max_y = box.offsetTop + box.offsetHeight;
//			if ( max_y > maxy ) maxy = max_y;
			}
		factor = picw / maxx;
		zoom_divs(factor-1);
		}

	window.setTimeout('zoom(-2700); adjust_size();', 300);		// FIXME: temporary workaround for the problem, that graphviz pictures have strange dimensions

	var green = '#10b010';
	var red = 'transparent';//'#a00808';

	function wheel(event){
		var delta = 0;
		if (!event) event = window.event;
		if (event.wheelDelta) {
			delta = event.wheelDelta/120; 
		} else if (event.detail) {
			delta = -event.detail/3;
		}
		if (delta) {
			if ( event.shiftKey ) {
				if (delta < 0)
					zoom_divs(-0.05);
				else
					zoom_divs(0.05);
			} else	{
				if (delta < 0)
					zoom(-60);
				else
					zoom(60);
				}
			}
		if (event.preventDefault)
		        event.preventDefault();
		event.returnValue = false;
	}

	if (window.addEventListener)
		window.addEventListener('DOMMouseScroll', wheel, false);
	window.onmousewheel = document.onmousewheel = wheel;

	function ChangeVisibility(event) {
		if ( event.srcElement.checked ) value = 'visible'
		else				value = 'hidden';
		for (var i = 0; i < Boxes.length; i++) document.getElementById(Boxes[i]).style.visibility = value;
		}

	function Reset() {
		document.getElementById('Progress').innerHTML = 'Resetting ...';
{{ = XML(reset) }}
		document.getElementById('Progress').innerHTML = 'Reset.';
		}

	window.setTimeout('Reset();', 200);

	function Iterate() {
		document.getElementById('Progress').innerHTML = 'Updating ...';
{{ = XML(updateRules) }}
{{ = XML(shiftRules) }}
{{ = XML(updateBoxes) }}
		document.getElementById('Progress').innerHTML = 'Updated.';
		if ( document.getElementById('ContinuousIteration').checked == 1 ) window.setTimeout('Iterate();', 100);
		}

	window.setTimeout('Iterate();', 800);

	function Stop() {
		document.getElementById('ContinuousIteration').checked = false;
		}

	function NodeClick(event) {
		document.getElementById('Progress').innerHTML = 'Changing node ...';
		e = event.srcElement;
		currently = window.getComputedStyle(e).getPropertyValue('background-color');
		s = currently.replace('rgb(','').split(',')
		var R = parseInt(s[0]);
		var G = parseInt(s[1]);
		if ( G > R )	state = true
		else		state = false;
		if ( state == true )	e.style.background = red;
		else			e.style.background = green;
		document.getElementById('Progress').innerHTML = 'Changed.';
		}
</script>

[ <a href="../Layout/graphviz">Redo layout</a> ], 
[ <a href="../Layout/graphviz_layout">Download DOT layout</a> ], 
[ <a href="../Export/JSON">Download JSON model</a> ], 
[ <a href="{{ = session.graphviz_png }}">Download picture</a> ]

<div id=Controls>
	<input id=ShowBooleBoxes type=checkbox onClick="ChangeVisibility(event);" checked> Show boolean network boxes
	<input id=ContinuousIteration type=checkbox checked onClick="Iterate();"> Continuous Iteration

	<form name=main action="{{=URL(r=request, c='Import', f='BooleanNet')}}" method=POST enctype="multipart/form-data">
		<input type=hidden name=Layouter value=graphviz />
	{{ if os.path.exists('/home/Master/Network/Whi2p.boolenet'): }}
		<input type=submit value="Load Matthias's Whi2p Network" />
	{{ pass }}
		<input type=button value="Adjust" onClick="adjust_size();" />
		<input type=button value="Reset" onClick="Reset();" />
		<input type=button value="Iterate once" onClick="Stop(); Iterate();" />
		<input type=button value="Stop" onClick="Stop();" />
	</form>
</div>

<br/>
Use mouse wheel to zoom in or out. Shift+Wheel to zoom the boxes. <label id='Progress' style='color:green; font-weight:bold;'></label>

<div id=canvas>

	<img name=network id=network src="{{ = session.graphviz_image }}" />

{{ = XML(BoundingBoxes) }}

	<script>Boxes = new Array({{ = XML(Boxes) }});</script>

</div>
